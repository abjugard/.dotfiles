#!/usr/bin/env bash
scriptname=`basename $0`
if [[ -z $1 ]]; then
    echo "$scriptname: Service Name Req'd"
    echo ""
    echo "Usage:"
    echo "   otp google"
    echo ""
    echo "Configuration: ~/.config/otpkeys.enc"
    echo "Format: name=key"
    echo "(configuration is encrypted using aes-256-cbc)"
    exit
fi

echoerr() { echo "$@" 1>&2; }

conf="$HOME/.config/otpkeys.enc"

echoerr -n Password:
read -s pass
echoerr

out=$(openssl aes-256-cbc -d -a -in $conf -pass pass:$pass 2>/dev/null)
if [[ $? -ne 0 ]]; then
    echo "Bad password"
    exit
fi

data=` echo "$out" | grep ^$1 | cut -d"=" -f 2 | sed "s/ //g" `
if [[ -z $data ]]; then
    echo "$scriptname: Bad Service Name"
    exit
fi
if [[ $data == *":"* ]]; then
    otpkey=` echo $data | cut -d: -f1 `
    digits=` echo $data | cut -d: -f2 `
else
    otpkey=$data
    digits=6
fi

/usr/local/bin/oathtool --totp -b $otpkey -d $digits
