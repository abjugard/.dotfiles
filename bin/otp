#!/usr/bin/env bash
scriptname=`basename $0`
if [ -z $1 ]
then
    echo "$scriptname: Service Name Req'd"
    echo ""
    echo "Usage:"
    echo "   otp google"
    echo ""
    echo "Configuration: ~/.config/otpkeys.enc"
    echo "Format: name=key"
    echo "(configuration is encrypted using aes-256-cbc)"
    exit
fi

conf="$HOME/.config/otpkeys.enc"
tempfile=$(mktemp)

echo -n Password:
read -s pass
echo

openssl aes-256-cbc -d -a -in $conf -out $tempfile -pass pass:$pass 2>/dev/null
if [ $? -ne 0 ]; then
    echo "Bad password"
    exit
fi

otpkey=` grep ^$1 $tempfile | cut -d"=" -f 2 | sed "s/ //g" `
rm -f $tempfile
if [ -z $otpkey ]
then
    echo "$scriptname: Bad Service Name"
    exit
fi
/usr/local/bin/oathtool --totp -b $otpkey
